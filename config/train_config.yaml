# Main configuration file for Hydra.
# This is the entry point for all configuration management.
# Specific configs are organized in subdirectories.

# Defaults - these are applied in order
defaults:
  - override hydra/hydra_logging: none
  - override hydra/job_logging: none

# Model configuration
model:
  name: "convnext_tiny_cbam"
  num_classes: 5
  pretrained: true
  cbam_stages: [3, 4]

# Loss function configuration
loss:
  type: "focal_loss"
  alpha: [0.375, 0.99, 0.99, 0.375, 0.99]  #dynamic or manual alpha values: [no_defect, defect_1, defect_2, defect_3, defect_4]
  gamma: 2.5  # Increased from 2.5 - more aggressive focusing on hard examples
  reduction: "mean"
  use_effective_num: false  # Use Class-Balanced Loss (Cui et al., CVPR 2019)
  beta: 0.99  # Hyperparameter for effective number calculation

# Data configuration
data:
  img_dir: "data/images"
  ann_dir: "data/annotations"
  batch_size: 24  # Stable batch size for this GPU
  num_workers: 4  # Parallel data loading
  pin_memory: true  # Faster GPU transfers
  image_size: [256, 1600]  # [height, width]
  num_classes: 5
  class_names: ["no_defect", "defect_1", "defect_2", "defect_3", "defect_4"]
  
  # Split strategy: "stratified_70_15_15" or "stratified_80_10_10"
  split_strategy: "stratified_70_15_15"

# Augmentation configuration
augmentation:
  horizontal_flip: 0.5
  vertical_flip: 0.5
  # rotation: disabled - could move defects outside visible area
  brightness_contrast:
    brightness: 0.3  # Increased from 0.2 - more variety for rare classes
    contrast: 0.3    # Increased from 0.2
  
  # Defect Blackout Augmentation (for wide-strip dataset only)
  # Helps model learn contextual features by randomly masking defect regions
  defect_blackout:
    enabled: false  # Set to true to enable blackout augmentation
    instance_blackout_prob: 0.5  # Probability of blacking out each defect instance
    defect_indices_to_blackout: [1,2]  # null = all defects [1,2,3,4], or list like [2] for only defect_2
    min_pixels_to_blackout: 15  # Minimum defect size to consider for blackout
    complete_blackout_prob: 0.0  # Probability of blacking out ALL defects (creates clean samples)
    fill_value: 0  # Black pixels
    verbose: false  # Set to true for debug logging

# Training configuration
training:
  num_epochs: 100
  learning_rate: 0.001
  weight_decay: 0.0001
  warmup_epochs: 5
  early_stopping_patience: 15
  early_stopping_metric: "f1_macro"
  log_interval: 10
  threshold: 0.5
  
  # Optional: freeze backbone for transfer learning
  freeze_backbone: false
  freeze_early_stages: null  # Set to number of stages to freeze

# Optimization
optimizer:
  type: "adamw"
  lr: 0.001
  weight_decay: 0.0001
  betas: [0.9, 0.999]

scheduler:
  type: "cosine"
  warmup_epochs: 5

# Experiment configuration
experiment:
  name: null  # Will be generated from timestamp if null
  seed: 42
  save_dir: "code/experiments/results"

# Hydra specific config
hydra:
  run:
    dir: code/experiments/results/${now:%Y-%m-%d}/${now:%H-%M-%S}
  job:
    chdir: false
